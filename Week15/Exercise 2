#!/usr/bin/env python
# coding: utf-8

# In[2]:


# main.py
from fastapi import FastAPI, HTTPException, Response
from pydantic import BaseModel
from typing import Any, Dict, List, Optional

from user_store import UserStore

app = FastAPI()
store = UserStore("users.db")


def dump_model(model: BaseModel, **kwargs) -> Dict[str, Any]:
    """
    Compatibility helper:
    - Pydantic v2: model.model_dump(...)
    - Pydantic v1: model.dict(...)
    """
    if hasattr(model, "model_dump"):  # pydantic v2
        return model.model_dump(**kwargs)
    return model.dict(**kwargs)       # pydantic v1


class UserCreate(BaseModel):
    name: str
    email: str
    age: Optional[int] = None


class UserPatch(BaseModel):
    name: Optional[str] = None
    email: Optional[str] = None
    age: Optional[int] = None


@app.get("/users")
def get_users() -> List[Dict[str, Any]]:
    return store.load()


@app.get("/users/{user_id}")
def get_user(user_id: int) -> Dict[str, Any]:
    user = store.find_by_id(user_id)
    if user is None:
        raise HTTPException(status_code=404, detail="User not found")
    return user


@app.post("/users", status_code=201)
def create_user(payload: UserCreate) -> Dict[str, Any]:
    # following lab style: load -> append -> save
    users = store.load()
    new_user = dump_model(payload)  # âœ… works on pydantic v1/v2
    users.append(new_user)

    store.save(users)  # save() will insert and attach id into new_user
    return new_user


@app.put("/users/{user_id}")
def update_user(user_id: int, payload: UserPatch) -> Dict[str, Any]:
    updated_data = dump_model(payload, exclude_none=True)  

    ok = store.update_user(user_id, updated_data)
    if not ok:
        raise HTTPException(status_code=404, detail="User not found")

    return store.find_by_id(user_id)


@app.delete("/users/{user_id}", status_code=204)
def delete_user(user_id: int) -> Response:
    ok = store.delete_user(user_id)
    if not ok:
        raise HTTPException(status_code=404, detail="User not found")
    return Response(status_code=204)


# In[ ]:




